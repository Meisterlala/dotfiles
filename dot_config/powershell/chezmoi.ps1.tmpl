### Setup Chezmoi

# Start completion job
$chezmoiJob = Start-Job {
    New-Module -Name chezmoi -ScriptBlock {Invoke-Expression (chezmoi completion powershell | Out-String)}
}

# Define the edit helper function and alias right away
function Chezmoi-Edit-With-Args {
    param (
        [string]$FilePath
    )
    if ([string]::IsNullOrWhiteSpace($FilePath)) {
        chezmoi managed -t
    } else {
        chezmoi edit --watch -a $FilePath
    }
}
Set-Alias -Name ce -Value Chezmoi-Edit-With-Args | Out-Null

# Register idle handler to load completions when ready
Register-EngineEvent -SourceIdentifier PowerShell.OnIdle -SupportEvent -Action {
    if ($chezmoiJob.State -eq 'Completed') {
        # Unregister this handler (needed because -SupportEvent was used)
        Unregister-Event -SubscriptionId $EventSubscriber.SubscriptionId -Force

        $completion = Receive-Job -Job $chezmoiJob -Wait
        Remove-Job $chezmoiJob

        $completion | Import-Module -Global
    }
} | Out-Null
